<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#003B46">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../assets/icon-192.svg">
    <title>CRM - מטפל לכל אחד</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/docx@8.2.2/build/index.umd.js"></script>
    <script>
        // AUTH GUARD - Redirect to login if not authenticated
        (async function() {
            const SUPABASE_URL = 'https://eimcudmlfjlyxjyrdcgc.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbWN1ZG1sZmpseXhqeXJkY2djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MTA5MDYsImV4cCI6MjA4NDk4NjkwNn0.ESXViZ0DZxopHxHNuC6vRn3iIZz1KZkQcXwgLhK_nQw';
            const tempClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await tempClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
        })();
    </script>
    <style>
        /* Dark Mode (Default) */
        :root {
            --bg: #0f1419;
            --card: #1a1f2e;
            --card-hover: #242b3d;
            --border: #2d3548;
            --text: #ffffff;
            --text-secondary: #8b949e;
            --gold: #D4AF37;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --info: #58a6ff;
        }

        /* Light Mode */
        [data-theme="light"] {
            --bg: #f5f7fa;
            --card: #ffffff;
            --card-hover: #f0f2f5;
            --border: #e1e5eb;
            --text: #1a1a2e;
            --text-secondary: #6c757d;
            --gold: #c9a227;
            --success: #28a745;
            --warning: #e6a817;
            --danger: #dc3545;
            --info: #0d6efd;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Heebo', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; transition: background 0.3s, color 0.3s; }

        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { display: flex; align-items: center; gap: 0.8rem; font-size: 1.2rem; font-weight: 700; }
        .logo i { color: var(--gold); }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .btn-logout {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-logout:hover { border-color: var(--danger); color: var(--danger); }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            border-color: var(--gold);
            color: var(--gold);
            transform: rotate(15deg);
        }
        [data-theme="light"] .theme-toggle .fa-moon { display: none; }
        [data-theme="light"] .theme-toggle .fa-sun { display: inline; }
        :root .theme-toggle .fa-sun { display: none; }
        :root .theme-toggle .fa-moon { display: inline; }

        .main { display: flex; min-height: calc(100vh - 60px); }

        .sidebar {
            width: 220px;
            background: var(--card);
            border-left: 1px solid var(--border);
            padding: 1.5rem 1rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(212, 175, 55, 0.1); color: var(--gold); }
        .nav-item .badge {
            margin-right: auto;
            background: var(--gold);
            color: var(--bg);
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .content { flex: 1; padding: 2rem; }
        .page-title { font-size: 1.5rem; margin-bottom: 1.5rem; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--gold); }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; }

        .table-container { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .search-box input {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            outline: none;
            width: 200px;
        }
        .search-box i { color: var(--text-secondary); }

        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: right; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); }
        th { background: var(--bg); color: var(--text-secondary); font-weight: 500; font-size: 0.85rem; }
        tr:hover { background: var(--card-hover); }

        .status-badge { padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .status-new { background: rgba(212, 175, 55, 0.2); color: var(--gold); }
        .status-pending_review { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
        .status-waiting { background: rgba(88, 166, 255, 0.2); color: var(--info); }
        .status-matched, .status-approved { background: rgba(88, 166, 255, 0.2); color: var(--info); }
        .status-in_treatment, .status-active { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .status-completed { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }
        .status-rejected, .status-inactive { background: rgba(248, 81, 73, 0.2); color: var(--danger); }

        .verified-badge { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.8rem; }
        .verified-badge.yes { color: var(--success); }
        .verified-badge.no { color: var(--text-secondary); }

        /* Premium Button System */
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--gold);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--gold);
        }
        .btn:hover {
            background: var(--gold);
            color: var(--bg);
        }
        .btn-gold {
            background: var(--gold);
            color: var(--bg);
            border: 1px solid var(--gold);
        }
        .btn-gold:hover {
            background: transparent;
            color: var(--gold);
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
        }
        .btn-outline:hover {
            background: var(--gold);
            color: var(--bg);
        }
        .btn-success {
            background: transparent;
            color: var(--success);
            border: 1px solid var(--success);
        }
        .btn-success:hover {
            background: var(--success);
            color: white;
        }
        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }
        .btn-export {
            background: transparent;
            color: var(--gold);
            border: 1px solid var(--gold);
        }
        .btn-export:hover {
            background: var(--gold);
            color: var(--bg);
        }
        .btn-export i { margin-left: 0.4rem; }

        /* Table Action Buttons */
        .action-btns {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--gold);
            border-radius: 6px;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-icon:hover {
            background: var(--gold);
            color: var(--bg);
        }
        .btn-icon.danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        .btn-icon.danger:hover {
            background: var(--danger);
            color: white;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
        }
        .modal-body { max-height: 70vh; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { display: flex; align-items: center; gap: 0.5rem; }
        .modal-header h2 i { color: var(--gold); }
        .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .detail-row { display: flex; padding: 0.8rem 0; border-bottom: 1px solid var(--border); }
        .detail-label { width: 140px; color: var(--text-secondary); flex-shrink: 0; }
        .detail-value { flex: 1; }
        .detail-section { margin-top: 1.5rem; }
        .detail-section h4 { color: var(--gold); margin-bottom: 0.8rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .questionnaire-answer {
            background: var(--bg);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Tags/Badges for therapy methods */
        .method-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .method-tag {
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold);
            padding: 0.3rem 0.7rem;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* Section dividers */
        .modal-section-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0 1rem;
            color: var(--gold);
            font-weight: 600;
        }
        .modal-section-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .modal-section-divider i { font-size: 0.9rem; }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin: 0.8rem 0;
        }
        .stat-box {
            background: var(--bg);
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
        }
        .stat-box .value { font-size: 1.3rem; font-weight: 700; color: var(--gold); }
        .stat-box .label { font-size: 0.75rem; color: var(--text-secondary); }

        /* Health indicators */
        .health-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.7rem;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        .health-indicator.yes { background: rgba(248, 81, 73, 0.15); color: var(--danger); }
        .health-indicator.no { background: rgba(63, 185, 80, 0.15); color: var(--success); }

        /* Social link button */
        .social-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: rgba(88, 166, 255, 0.15);
            color: var(--info);
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .social-link-btn:hover { background: rgba(88, 166, 255, 0.25); }

        .verification-toggle {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 10px;
            margin-top: 1rem;
        }
        .verification-toggle label { color: var(--text-secondary); }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--border);
            border-radius: 26px;
            transition: 0.3s;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            right: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--success); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(-24px); }

        .match-form { display: flex; gap: 1rem; align-items: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .match-form .form-group { flex: 1; }
        .match-form label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .match-form select, select {
            width: 100%;
            padding: 0.7rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }

        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 2rem; }
        .login-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h1 { margin-bottom: 0.5rem; }
        .login-card p { color: var(--text-secondary); margin-bottom: 2rem; }
        .login-card .form-group { margin-bottom: 1rem; text-align: right; }
        .login-card label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .login-card input {
            width: 100%;
            padding: 0.9rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
        }
        .login-card .btn { width: 100%; padding: 1rem; font-size: 1rem; margin-top: 1rem; }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 1rem 2rem;
            border-radius: 10px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }

        .hidden { display: none; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .tab {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
        }
        .tab:hover { border-color: var(--gold); color: var(--gold); }
        .tab.active { background: var(--gold); color: var(--bg); border-color: var(--gold); }
    </style>
</head>
<body>
    <!-- Dashboard -->
    <div id="dashboard">
        <header class="header">
            <div class="logo">
                <i class="fa-solid fa-heart-pulse"></i>
                <span>מטפל לכל אחד - CRM</span>
            </div>
            <div class="user-info">
                <button class="theme-toggle" onclick="toggleTheme()" title="החלף מצב תצוגה">
                    <i class="fa-solid fa-sun"></i>
                    <i class="fa-solid fa-moon"></i>
                </button>
                <span id="user-email"></span>
                <button class="btn-logout" onclick="logout()">
                    <i class="fa-solid fa-sign-out-alt"></i> יציאה
                </button>
            </div>
        </header>

        <div class="main">
            <nav class="sidebar">
                <div class="nav-item active" onclick="switchView('patients')">
                    <i class="fa-solid fa-user-injured"></i>
                    <span>מטופלים</span>
                    <span class="badge" id="patients-count">0</span>
                </div>
                <div class="nav-item" onclick="switchView('therapists')">
                    <i class="fa-solid fa-user-doctor"></i>
                    <span>מטפלים</span>
                    <span class="badge" id="therapists-count">0</span>
                </div>
                <div class="nav-item" onclick="switchView('matches')">
                    <i class="fa-solid fa-handshake"></i>
                    <span>שידוכים</span>
                    <span class="badge" id="matches-count">0</span>
                </div>
            </nav>

            <main class="content">
                <!-- Patients View -->
                <div id="patients-view">
                    <h1 class="page-title">מטופלים</h1>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-new">0</div>
                            <div class="stat-label">חדשים</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-waiting">0</div>
                            <div class="stat-label">ממתינים לשיבוץ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-in-treatment">0</div>
                            <div class="stat-label">בטיפול</div>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab active" onclick="filterPatients('all')">הכל</button>
                        <button class="tab" onclick="filterPatients('new')">חדשים</button>
                        <button class="tab" onclick="filterPatients('waiting')">ממתינים</button>
                        <button class="tab" onclick="filterPatients('in_treatment')">בטיפול</button>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <div style="display:flex;align-items:center;gap:1rem;">
                                <h3>רשימת מטופלים</h3>
                                <button class="btn btn-export" onclick="exportPatientsCSV()">
                                    <i class="fa-solid fa-file-excel"></i> ייצא לאקסל
                                </button>
                            </div>
                            <div class="search-box">
                                <i class="fa-solid fa-search"></i>
                                <input type="text" placeholder="חיפוש..." id="patient-search" oninput="renderPatients()">
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>שם</th>
                                    <th>טלפון</th>
                                    <th>עיר</th>
                                    <th>מאומת</th>
                                    <th>סטטוס</th>
                                    <th>תאריך</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="patients-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Therapists View -->
                <div id="therapists-view" class="hidden">
                    <h1 class="page-title">מטפלים</h1>
                    <div class="tabs">
                        <button class="tab active" onclick="filterTherapists('all')">הכל</button>
                        <button class="tab" onclick="filterTherapists('new')">חדשים</button>
                        <button class="tab" onclick="filterTherapists('approved')">מאושרים</button>
                        <button class="tab" onclick="filterTherapists('active')">פעילים</button>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <div style="display:flex;align-items:center;gap:1rem;">
                                <h3>רשימת מטפלים</h3>
                                <button class="btn btn-export" onclick="exportTherapistsCSV()">
                                    <i class="fa-solid fa-file-excel"></i> ייצא לאקסל
                                </button>
                            </div>
                            <div class="search-box">
                                <i class="fa-solid fa-search"></i>
                                <input type="text" placeholder="חיפוש..." id="therapist-search" oninput="renderTherapists()">
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>שם</th>
                                    <th>טלפון</th>
                                    <th>התמחות</th>
                                    <th>ניסיון</th>
                                    <th>מסמכים</th>
                                    <th>סטטוס</th>
                                    <th>תאריך</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="therapists-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Matches View -->
                <div id="matches-view" class="hidden">
                    <h1 class="page-title">שידוכים</h1>
                    <div class="table-container">
                        <div class="table-header">
                            <h3>רשימת שידוכים</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>מטופל</th>
                                    <th>מטפל</th>
                                    <th>סטטוס</th>
                                    <th>פגישות</th>
                                    <th>תאריך</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="matches-table"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Patient Modal -->
    <div class="modal-overlay" id="patient-modal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fa-solid fa-user"></i> <span id="modal-patient-name">פרטי מטופל</span></h2>
                <button class="modal-close" onclick="closeModal('patient-modal')">&times;</button>
            </div>
            <div class="modal-body" id="patient-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-gold" onclick="printSignedDocument('patient')">
                    <i class="fa-solid fa-file-pdf"></i> הפק מסמך חתום
                </button>
                <button class="btn btn-outline" onclick="closeModal('patient-modal')">סגור</button>
            </div>
        </div>
    </div>

    <!-- Therapist Modal -->
    <div class="modal-overlay" id="therapist-modal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fa-solid fa-user-doctor"></i> <span id="modal-therapist-name">פרטי מטפל</span></h2>
                <button class="modal-close" onclick="closeModal('therapist-modal')">&times;</button>
            </div>
            <div class="modal-body" id="therapist-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-gold" onclick="printSignedDocument('therapist')">
                    <i class="fa-solid fa-file-pdf"></i> הפק מסמך חתום
                </button>
                <button class="btn btn-outline" onclick="closeModal('therapist-modal')">סגור</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fa-solid fa-file-export"></i> <span id="export-modal-title">ייצוא לאקסל</span></h2>
                <button class="modal-close" onclick="closeModal('export-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-filters">
                    <!-- Status Filter -->
                    <div class="filter-group">
                        <label><i class="fa-solid fa-filter"></i> סינון לפי סטטוס</label>
                        <div class="checkbox-filter-grid" id="export-status-filters"></div>
                    </div>

                    <!-- Date Range Filter -->
                    <div class="filter-group">
                        <label><i class="fa-solid fa-calendar"></i> טווח תאריכים</label>
                        <div class="date-range-inputs">
                            <div>
                                <span>מתאריך:</span>
                                <input type="date" id="export-date-from">
                            </div>
                            <div>
                                <span>עד תאריך:</span>
                                <input type="date" id="export-date-to">
                            </div>
                        </div>
                    </div>

                    <!-- Verified Filter -->
                    <div class="filter-group">
                        <label><i class="fa-solid fa-check-circle"></i> סינון לפי אימות</label>
                        <div class="radio-filter-group">
                            <label class="radio-item">
                                <input type="radio" name="export-verified" value="all" checked>
                                <span>הכל</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="export-verified" value="yes">
                                <span>מאומתים בלבד</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="export-verified" value="no">
                                <span>לא מאומתים</span>
                            </label>
                        </div>
                    </div>

                    <!-- Preview Count -->
                    <div class="export-preview">
                        <i class="fa-solid fa-table"></i>
                        <span id="export-count">0</span> רשומות יייוצאו
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('export-modal')">ביטול</button>
                <button class="btn btn-gold" onclick="executeExport()">
                    <i class="fa-solid fa-download"></i> הורד קובץ
                </button>
            </div>
        </div>
    </div>

    <style>
        .export-filters { display: flex; flex-direction: column; gap: 1.5rem; }
        .filter-group label { display: block; margin-bottom: 0.6rem; font-weight: 600; color: var(--gold); font-size: 0.95rem; }
        .filter-group label i { margin-left: 0.4rem; }
        .checkbox-filter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .checkbox-filter-grid label {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.8rem; background: var(--bg); border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .checkbox-filter-grid label:hover { background: var(--card-hover); }
        .checkbox-filter-grid input[type="checkbox"] { accent-color: var(--gold); width: 16px; height: 16px; }
        .date-range-inputs { display: flex; gap: 1rem; }
        .date-range-inputs > div { flex: 1; }
        .date-range-inputs span { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.3rem; }
        .date-range-inputs input {
            width: 100%; padding: 0.6rem; background: var(--bg); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-family: inherit;
        }
        .date-range-inputs input:focus { border-color: var(--gold); outline: none; }
        .radio-filter-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .radio-item {
            display: flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 1rem; background: var(--bg); border-radius: 20px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .radio-item:hover { background: var(--card-hover); }
        .radio-item input[type="radio"] { accent-color: var(--gold); }
        .export-preview {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 1rem; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px; color: var(--gold); font-weight: 600;
        }
        .export-preview span { font-size: 1.3rem; }
    </style>

    <script>
        // ===================
        // THEME TOGGLE
        // ===================
        function initTheme() {
            const savedTheme = localStorage.getItem('admin-theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }
        initTheme(); // Run immediately

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            if (newTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            localStorage.setItem('admin-theme', newTheme);
        }

        // Supabase Configuration
        const SUPABASE_URL = 'https://eimcudmlfjlyxjyrdcgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbWN1ZG1sZmpseXhqeXJkY2djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MTA5MDYsImV4cCI6MjA4NDk4NjkwNn0.ESXViZ0DZxopHxHNuC6vRn3iIZz1KZkQcXwgLhK_nQw';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let patients = [];
        let therapists = [];
        let matches = [];
        let currentPatientFilter = 'all';
        let currentTherapistFilter = 'all';
        let currentViewedPatient = null;
        let currentViewedTherapist = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                document.getElementById('user-email').textContent = session.user.email;
                loadAllData();
            }
        });

        async function logout() {
            await db.auth.signOut();
            window.location.href = 'login.html';
        }

        async function loadAllData() {
            await Promise.all([loadPatients(), loadTherapists(), loadMatches()]);
            updateCounts();
        }

        async function loadPatients() {
            const { data } = await db.from('patients').select('*').order('created_at', { ascending: false });
            patients = data || [];
            renderPatients();
        }

        async function loadTherapists() {
            const { data } = await db.from('therapists').select('*').order('created_at', { ascending: false });
            therapists = data || [];
            renderTherapists();
        }

        async function loadMatches() {
            const { data } = await db.from('matches').select('*, therapists(full_name), patients(full_name)').order('created_at', { ascending: false });
            matches = data || [];
            renderMatches();
        }

        function updateCounts() {
            document.getElementById('patients-count').textContent = patients.length;
            document.getElementById('therapists-count').textContent = therapists.length;
            document.getElementById('matches-count').textContent = matches.length;
            document.getElementById('stat-new').textContent = patients.filter(p => p.status === 'new').length;
            document.getElementById('stat-waiting').textContent = patients.filter(p => p.status === 'waiting').length;
            document.getElementById('stat-in-treatment').textContent = patients.filter(p => p.status === 'in_treatment').length;
        }

        function switchView(view) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('patients-view').classList.toggle('hidden', view !== 'patients');
            document.getElementById('therapists-view').classList.toggle('hidden', view !== 'therapists');
            document.getElementById('matches-view').classList.toggle('hidden', view !== 'matches');
        }

        function filterPatients(status) {
            currentPatientFilter = status;
            document.querySelectorAll('#patients-view .tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderPatients();
        }

        function filterTherapists(status) {
            currentTherapistFilter = status;
            document.querySelectorAll('#therapists-view .tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderTherapists();
        }

        function renderPatients() {
            const search = document.getElementById('patient-search')?.value?.toLowerCase() || '';
            let filtered = patients;
            if (currentPatientFilter !== 'all') filtered = filtered.filter(p => p.status === currentPatientFilter);
            if (search) filtered = filtered.filter(p => p.full_name?.toLowerCase().includes(search) || p.phone?.includes(search));

            const tbody = document.getElementById('patients-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fa-solid fa-inbox"></i><br>אין מטופלים</td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(p => `
                <tr>
                    <td><strong>${p.full_name}</strong></td>
                    <td><a href="tel:${p.phone}" style="color:var(--info);text-decoration:none;">${p.phone || '-'}</a></td>
                    <td>${p.city || '-'}</td>
                    <td><span class="verified-badge ${p.id_verified ? 'yes' : 'no'}">
                        <i class="fa-solid ${p.id_verified ? 'fa-check-circle' : 'fa-clock'}"></i>
                        ${p.id_verified ? 'מאומת' : 'ממתין'}
                    </span></td>
                    <td><span class="status-badge status-${p.status}">${statusLabel(p.status)}</span></td>
                    <td>${formatDate(p.created_at)}</td>
                    <td class="action-btns"><button class="btn-icon" onclick="viewPatient('${p.id}')" title="צפייה"><i class="fa-solid fa-eye"></i></button></td>
                </tr>
            `).join('');
        }

        function renderTherapists() {
            const search = document.getElementById('therapist-search')?.value?.toLowerCase() || '';
            let filtered = therapists;
            if (currentTherapistFilter !== 'all') filtered = filtered.filter(t => t.status === currentTherapistFilter);
            if (search) filtered = filtered.filter(t => t.full_name?.toLowerCase().includes(search) || t.phone?.includes(search));

            const tbody = document.getElementById('therapists-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-inbox"></i><br>אין מטפלים</td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td><strong>${t.full_name}</strong></td>
                    <td><a href="tel:${t.phone}" style="color:var(--info);text-decoration:none;">${t.phone || '-'}</a></td>
                    <td>${t.specialization || '-'}</td>
                    <td style="text-align:center;">${t.experience_years || 0} שנים</td>
                    <td><span class="verified-badge ${t.documents_verified ? 'yes' : 'no'}">
                        <i class="fa-solid ${t.documents_verified ? 'fa-check-circle' : 'fa-clock'}"></i>
                        ${t.documents_verified ? 'מאומת' : 'ממתין'}
                    </span></td>
                    <td><span class="status-badge status-${t.status}">${statusLabel(t.status)}</span></td>
                    <td>${formatDate(t.created_at)}</td>
                    <td class="action-btns">
                        <button class="btn-icon" onclick="viewTherapist('${t.id}')" title="צפייה"><i class="fa-solid fa-eye"></i></button>
                        ${t.status === 'new' ? `<button class="btn-icon" style="border-color:var(--success);color:var(--success);" onclick="approveTherapist('${t.id}')" title="אשר"><i class="fa-solid fa-check"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderMatches() {
            const tbody = document.getElementById('matches-table');
            if (matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fa-solid fa-handshake"></i><br>אין שידוכים</td></tr>';
                return;
            }
            tbody.innerHTML = matches.map(m => `
                <tr>
                    <td>${m.patients?.full_name || '-'}</td>
                    <td>${m.therapists?.full_name || '-'}</td>
                    <td><span class="status-badge status-${m.status}">${statusLabel(m.status)}</span></td>
                    <td>${m.session_count || 0}</td>
                    <td>${formatDate(m.created_at)}</td>
                    <td>
                        <select onchange="updateMatchStatus('${m.id}', this.value)" style="padding:0.3rem;font-size:0.8rem;">
                            <option value="new" ${m.status === 'new' ? 'selected' : ''}>חדש</option>
                            <option value="active" ${m.status === 'active' ? 'selected' : ''}>פעיל</option>
                            <option value="completed" ${m.status === 'completed' ? 'selected' : ''}>הושלם</option>
                            <option value="cancelled" ${m.status === 'cancelled' ? 'selected' : ''}>בוטל</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function viewPatient(id) {
            const p = patients.find(x => x.id === id);
            if (!p) return;
            currentViewedPatient = p;
            document.getElementById('modal-patient-name').textContent = p.full_name;
            const q = p.questionnaire || {};

            document.getElementById('patient-modal-body').innerHTML = `
                <div class="detail-row"><div class="detail-label">טלפון</div><div class="detail-value"><a href="tel:${p.phone}" style="color:var(--info);">${p.phone || '-'}</a></div></div>
                <div class="detail-row"><div class="detail-label">אימייל</div><div class="detail-value">${p.email || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">עיר</div><div class="detail-value">${p.city || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">העדפת טיפול</div><div class="detail-value">${therapyTypeLabel(p.therapy_type)}</div></div>
                <div class="detail-row"><div class="detail-label">העדפת מטפל</div><div class="detail-value">${genderLabel(p.therapist_gender_preference)}</div></div>
                <div class="detail-row"><div class="detail-label">איש קשר לחירום</div><div class="detail-value">${q.emergency_contact || '-'}</div></div>
                <div class="detail-row">
                    <div class="detail-label">סטטוס</div>
                    <div class="detail-value">
                        <select id="patient-status-select">
                            <option value="new" ${p.status === 'new' ? 'selected' : ''}>חדש</option>
                            <option value="waiting" ${p.status === 'waiting' ? 'selected' : ''}>ממתין לשיבוץ</option>
                            <option value="matched" ${p.status === 'matched' ? 'selected' : ''}>שובץ</option>
                            <option value="in_treatment" ${p.status === 'in_treatment' ? 'selected' : ''}>בטיפול</option>
                            <option value="completed" ${p.status === 'completed' ? 'selected' : ''}>הושלם</option>
                            <option value="rejected" ${p.status === 'rejected' ? 'selected' : ''}>נדחה</option>
                        </select>
                        <button class="btn btn-gold" onclick="updatePatientStatus('${p.id}')" style="margin-right:0.5rem;">שמור</button>
                    </div>
                </div>

                <div class="verification-toggle">
                    <label>זהות מאומתת:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="patient-verified-toggle" ${p.id_verified ? 'checked' : ''} onchange="togglePatientVerification('${p.id}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="color: ${p.id_verified ? 'var(--success)' : 'var(--text-secondary)'};">${p.id_verified ? 'מאומת' : 'לא מאומת'}</span>
                </div>

                ${q.main_reason ? `<div class="detail-section"><h4><i class="fa-solid fa-comment-medical"></i> סיבת הפנייה</h4><div class="questionnaire-answer">${q.main_reason}</div></div>` : ''}
                ${q.previous_therapy ? `<div class="detail-section"><h4><i class="fa-solid fa-history"></i> טיפול קודם</h4><div class="questionnaire-answer">${q.previous_therapy}</div></div>` : ''}
                ${q.expectations ? `<div class="detail-section"><h4><i class="fa-solid fa-bullseye"></i> ציפיות</h4><div class="questionnaire-answer">${q.expectations}</div></div>` : ''}
                ${q.family_background ? `<div class="detail-section"><h4><i class="fa-solid fa-people-roof"></i> רקע משפחתי</h4><div class="questionnaire-answer">${q.family_background}</div></div>` : ''}
                ${q.medical_history ? `<div class="detail-section"><h4><i class="fa-solid fa-notes-medical"></i> רקע רפואי</h4><div class="questionnaire-answer">${q.medical_history}</div></div>` : ''}
                ${q.medications ? `<div class="detail-section"><h4><i class="fa-solid fa-pills"></i> תרופות</h4><div class="questionnaire-answer">${q.medications}</div></div>` : ''}
                ${q.additional_info ? `<div class="detail-section"><h4><i class="fa-solid fa-circle-info"></i> מידע נוסף</h4><div class="questionnaire-answer">${q.additional_info}</div></div>` : ''}

                <div class="match-form">
                    <div class="form-group">
                        <label><i class="fa-solid fa-handshake"></i> שיבוץ למטפל</label>
                        <select id="match-therapist-select">
                            <option value="">בחר מטפל...</option>
                            ${therapists.filter(t => t.status === 'active' || t.status === 'approved').map(t =>
                                `<option value="${t.id}">${t.full_name} - ${t.specialization || 'כללי'}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <button class="btn btn-gold" onclick="createMatch('${p.id}')">
                        <i class="fa-solid fa-check"></i> שבץ
                    </button>
                </div>

                <!-- DIGITAL SIGNATURE -->
                ${p.signature_data ? `
                <div class="modal-section-divider" style="margin-top: 1.5rem;"><i class="fa-solid fa-signature"></i> חתימה דיגיטלית</div>
                <div style="background: #fff; padding: 15px; border-radius: 8px; text-align: center;">
                    <img src="${p.signature_data}" alt="חתימה דיגיטלית" style="max-width: 100%; height: auto; max-height: 150px;">
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fa-solid fa-clock"></i> נחתם בתאריך: ${formatDateTime(p.created_at)}
                </div>
                ` : ''}
            `;
            document.getElementById('patient-modal').classList.add('active');
        }

        function viewTherapist(id) {
            const t = therapists.find(x => x.id === id);
            if (!t) return;
            currentViewedTherapist = t;
            document.getElementById('modal-therapist-name').textContent = t.full_name;
            const q = t.questionnaire || {};
            const health = q.health || {};
            const commitment = q.commitment || {};
            const practice = q.practice || {};

            // Format treatment methods as tags
            const methods = practice.treatment_methods || [];
            const methodTags = Array.isArray(methods) && methods.length > 0
                ? `<div class="method-tags">${methods.map(m => `<span class="method-tag">${m}</span>`).join('')}</div>`
                : '-';

            // Format therapy mode
            const therapyModeLabels = { 'zoom': 'זום בלבד', 'clinic': 'קליניקה בלבד', 'hybrid': 'משולב' };
            const therapyMode = therapyModeLabels[commitment.therapy_mode] || commitment.therapy_mode || '-';

            document.getElementById('therapist-modal-body').innerHTML = `
                <!-- BASIC INFO -->
                <div class="modal-section-divider"><i class="fa-solid fa-user"></i> פרטים אישיים</div>
                <div class="detail-row"><div class="detail-label">טלפון</div><div class="detail-value"><a href="tel:${t.phone}" style="color:var(--info);">${t.phone || '-'}</a></div></div>
                <div class="detail-row"><div class="detail-label">אימייל</div><div class="detail-value">${t.email || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">עיר</div><div class="detail-value">${t.city || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">מגדר</div><div class="detail-value">${genderDisplayLabel(t.gender)}</div></div>
                ${t.social_link ? `<div class="detail-row"><div class="detail-label">קישור חיצוני</div><div class="detail-value"><a href="${t.social_link}" target="_blank" class="social-link-btn"><i class="fa-solid fa-external-link"></i> פתח פרופיל</a></div></div>` : ''}

                <!-- PROFESSIONAL INFO -->
                <div class="modal-section-divider"><i class="fa-solid fa-briefcase-medical"></i> מידע מקצועי</div>
                <div class="detail-row"><div class="detail-label">התמחות</div><div class="detail-value">${t.specialization || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">שיטות טיפול</div><div class="detail-value">${methodTags}</div></div>
                <div class="detail-row"><div class="detail-label">רישיון</div><div class="detail-value">${t.license_number || '-'}</div></div>
                ${t.education ? `<div class="detail-row"><div class="detail-label">השכלה</div><div class="detail-value" style="white-space:pre-wrap;">${t.education}</div></div>` : ''}

                <!-- STATS -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value">${t.experience_years || 0}</div>
                        <div class="label">שנות ניסיון</div>
                    </div>
                    <div class="stat-box">
                        <div class="value">${practice.total_patients_estimate || 0}</div>
                        <div class="label">מטופלים לאורך הקריירה</div>
                    </div>
                    <div class="stat-box">
                        <div class="value">${practice.current_active_patients || 0}</div>
                        <div class="label">מטופלים פעילים</div>
                    </div>
                </div>

                <!-- WORK MODE & COMMITMENT -->
                <div class="modal-section-divider"><i class="fa-solid fa-calendar-check"></i> התחייבות ואופן עבודה</div>
                <div class="detail-row"><div class="detail-label">עבודה בזום</div><div class="detail-value">${t.works_online ? '<span style="color:var(--success);">✓ כן</span>' : 'לא'}</div></div>
                <div class="detail-row"><div class="detail-label">עבודה פרונטלית</div><div class="detail-value">${t.works_in_person ? '<span style="color:var(--success);">✓ כן</span>' : 'לא'}</div></div>
                <div class="detail-row"><div class="detail-label">אופן מועדף</div><div class="detail-value">${therapyMode}</div></div>
                <div class="detail-row"><div class="detail-label">שעות בחודש</div><div class="detail-value">${commitment.monthly_hours || t.available_hours_per_week * 4 || '-'}</div></div>
                <div class="detail-row"><div class="detail-label">תקופת התחייבות</div><div class="detail-value">${commitment.duration_months || '-'}</div></div>

                <!-- HEALTH DECLARATION -->
                <div class="modal-section-divider"><i class="fa-solid fa-heart-pulse"></i> הצהרת בריאות</div>
                <div class="detail-row">
                    <div class="detail-label">בעיות רפואיות</div>
                    <div class="detail-value">
                        <span class="health-indicator ${health.has_medical_issues ? 'yes' : 'no'}">
                            <i class="fa-solid ${health.has_medical_issues ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                            ${health.has_medical_issues ? 'יש' : 'אין'}
                        </span>
                    </div>
                </div>
                ${health.has_medical_issues && health.medical_issues_details ? `<div class="questionnaire-answer" style="margin-top:0.5rem;">${health.medical_issues_details}</div>` : ''}
                <div class="detail-row">
                    <div class="detail-label">תרופות פסיכיאטריות</div>
                    <div class="detail-value">
                        <span class="health-indicator ${health.takes_psychiatric_meds ? 'yes' : 'no'}">
                            ${health.takes_psychiatric_meds ? 'כן' : 'לא'}
                        </span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">בטיפול אישי</div>
                    <div class="detail-value">
                        <span class="health-indicator no">
                            ${health.in_personal_therapy ? 'כן' : 'לא'}
                        </span>
                    </div>
                </div>

                <!-- DEEP PROFILE -->
                <div class="modal-section-divider"><i class="fa-solid fa-heart"></i> פרופיל עומק</div>
                ${q.why_profession ? `<div class="detail-section"><h4><i class="fa-solid fa-lightbulb"></i> למה בחרת במקצוע הטיפול?</h4><div class="questionnaire-answer">${q.why_profession}</div></div>` : ''}
                ${q.why_join ? `<div class="detail-section"><h4><i class="fa-solid fa-handshake-angle"></i> למה הצטרפת לפרויקט?</h4><div class="questionnaire-answer">${q.why_join}</div></div>` : ''}
                ${q.experience ? `<div class="detail-section"><h4><i class="fa-solid fa-briefcase"></i> ניסיון מעשי</h4><div class="questionnaire-answer">${q.experience}</div></div>` : ''}
                ${q.case_study ? `<div class="detail-section"><h4><i class="fa-solid fa-brain"></i> מקרה מורכב (Case Study)</h4><div class="questionnaire-answer">${q.case_study}</div></div>` : ''}
                ${q.challenges ? `<div class="detail-section"><h4><i class="fa-solid fa-mountain"></i> אתגרים</h4><div class="questionnaire-answer">${q.challenges}</div></div>` : ''}

                <!-- ADMIN SECTION -->
                <div class="modal-section-divider"><i class="fa-solid fa-cog"></i> ניהול</div>
                <div class="detail-row">
                    <div class="detail-label">סטטוס</div>
                    <div class="detail-value">
                        <select id="therapist-status-select">
                            <option value="new" ${t.status === 'new' ? 'selected' : ''}>חדש</option>
                            <option value="pending_review" ${t.status === 'pending_review' ? 'selected' : ''}>בבדיקה</option>
                            <option value="approved" ${t.status === 'approved' ? 'selected' : ''}>מאושר</option>
                            <option value="active" ${t.status === 'active' ? 'selected' : ''}>פעיל</option>
                            <option value="inactive" ${t.status === 'inactive' ? 'selected' : ''}>לא פעיל</option>
                            <option value="rejected" ${t.status === 'rejected' ? 'selected' : ''}>נדחה</option>
                        </select>
                        <button class="btn btn-gold" onclick="updateTherapistStatus('${t.id}')" style="margin-right:0.5rem;">שמור</button>
                    </div>
                </div>

                <div class="verification-toggle">
                    <label>מסמכים מאומתים:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="therapist-verified-toggle" ${t.documents_verified ? 'checked' : ''} onchange="toggleTherapistVerification('${t.id}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="color: ${t.documents_verified ? 'var(--success)' : 'var(--text-secondary)'};">${t.documents_verified ? 'מאומת' : 'לא מאומת'}</span>
                </div>

                <div class="detail-row" style="margin-top:1rem;">
                    <div class="detail-label">תאריך הרשמה</div>
                    <div class="detail-value">${formatDate(t.created_at)}</div>
                </div>

                <!-- DIGITAL SIGNATURE -->
                ${t.signature_data ? `
                <div class="modal-section-divider"><i class="fa-solid fa-signature"></i> חתימה דיגיטלית</div>
                <div style="background: #fff; padding: 15px; border-radius: 8px; text-align: center;">
                    <img src="${t.signature_data}" alt="חתימה דיגיטלית" style="max-width: 100%; height: auto; max-height: 150px;">
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fa-solid fa-clock"></i> נחתם בתאריך: ${formatDateTime(t.created_at)}
                </div>
                ` : ''}
            `;
            document.getElementById('therapist-modal').classList.add('active');
        }

        function genderDisplayLabel(gender) {
            const labels = { 'male': 'זכר', 'female': 'נקבה', 'other': 'אחר' };
            return labels[gender] || gender || '-';
        }

        async function updatePatientStatus(id) {
            const status = document.getElementById('patient-status-select').value;
            const { error } = await db.from('patients').update({ status }).eq('id', id);
            if (error) { showToast('שגיאה בעדכון', 'error'); return; }
            showToast('הסטטוס עודכן', 'success');
            closeModal('patient-modal');
            loadPatients();
        }

        async function updateTherapistStatus(id) {
            const status = document.getElementById('therapist-status-select').value;
            const { error } = await db.from('therapists').update({ status }).eq('id', id);
            if (error) { showToast('שגיאה בעדכון', 'error'); return; }
            showToast('הסטטוס עודכן', 'success');
            closeModal('therapist-modal');
            loadTherapists();
        }

        async function togglePatientVerification(id, verified) {
            const { error } = await db.from('patients').update({
                id_verified: verified,
                verified_at: verified ? new Date().toISOString() : null
            }).eq('id', id);
            if (error) { showToast('שגיאה בעדכון', 'error'); return; }
            showToast(verified ? 'זהות אומתה' : 'אימות הוסר', 'success');
            loadPatients();
        }

        async function toggleTherapistVerification(id, verified) {
            const { error } = await db.from('therapists').update({
                documents_verified: verified,
                verified_at: verified ? new Date().toISOString() : null
            }).eq('id', id);
            if (error) { showToast('שגיאה בעדכון', 'error'); return; }
            showToast(verified ? 'מסמכים אומתו' : 'אימות הוסר', 'success');
            loadTherapists();
        }

        async function approveTherapist(id) {
            const { error } = await db.from('therapists').update({ status: 'approved' }).eq('id', id);
            if (error) { showToast('שגיאה באישור', 'error'); return; }
            showToast('המטפל אושר!', 'success');
            loadTherapists();
        }

        async function createMatch(patientId) {
            const therapistId = document.getElementById('match-therapist-select').value;
            if (!therapistId) { showToast('בחר מטפל', 'error'); return; }

            const { error } = await db.from('matches').insert({
                patient_id: patientId,
                therapist_id: therapistId,
                status: 'new'
            });

            if (error) {
                if (error.code === '23505') { showToast('שידוך כבר קיים', 'error'); }
                else { showToast('שגיאה ביצירת שידוך', 'error'); }
                return;
            }

            await db.from('patients').update({ status: 'matched' }).eq('id', patientId);
            showToast('השידוך נוצר!', 'success');
            closeModal('patient-modal');
            loadAllData();
        }

        async function updateMatchStatus(id, status) {
            const { error } = await db.from('matches').update({ status }).eq('id', id);
            if (error) { showToast('שגיאה בעדכון', 'error'); return; }
            showToast('הסטטוס עודכן', 'success');
            loadMatches();
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function statusLabel(status) {
            const labels = { 'new': 'חדש', 'pending_review': 'בבדיקה', 'waiting': 'ממתין', 'matched': 'שובץ', 'in_treatment': 'בטיפול', 'completed': 'הושלם', 'rejected': 'נדחה', 'approved': 'מאושר', 'active': 'פעיל', 'inactive': 'לא פעיל', 'cancelled': 'בוטל' };
            return labels[status] || status;
        }

        function therapyTypeLabel(type) {
            const labels = { 'online': 'זום (אונליין)', 'in_person': 'פרונטלי', 'both': 'שניהם' };
            return labels[type] || type || '-';
        }

        function genderLabel(gender) {
            const labels = { 'any': 'לא משנה', 'male': 'מטפל (גבר)', 'female': 'מטפלת (אישה)' };
            return labels[gender] || gender || '-';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('he-IL');
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('he-IL') + ' בשעה ' + date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeModal('patient-modal'); closeModal('therapist-modal'); closeModal('export-modal'); }
        });

        // ===================
        // CSV EXPORT FUNCTIONS
        // ===================

        let currentExportType = null; // 'therapists' or 'patients'

        function getDateString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('\n') || str.includes('"') || str.includes('\r')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function downloadCSV(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showToast('הקובץ הורד בהצלחה!', 'success');
        }

        // Open export modal with filters
        function openExportModal(type) {
            currentExportType = type;
            const isTherapists = type === 'therapists';

            document.getElementById('export-modal-title').textContent = isTherapists ? 'ייצוא מטפלים' : 'ייצוא מטופלים';

            // Build status checkboxes based on type
            const statusFilters = document.getElementById('export-status-filters');
            const statuses = isTherapists
                ? [
                    { value: 'new', label: 'חדש' },
                    { value: 'pending_review', label: 'בבדיקה' },
                    { value: 'approved', label: 'מאושר' },
                    { value: 'active', label: 'פעיל' },
                    { value: 'inactive', label: 'לא פעיל' },
                    { value: 'rejected', label: 'נדחה' }
                ]
                : [
                    { value: 'new', label: 'חדש' },
                    { value: 'waiting', label: 'ממתין' },
                    { value: 'matched', label: 'שובץ' },
                    { value: 'in_treatment', label: 'בטיפול' },
                    { value: 'completed', label: 'הושלם' },
                    { value: 'rejected', label: 'נדחה' }
                ];

            statusFilters.innerHTML = statuses.map(s => `
                <label>
                    <input type="checkbox" value="${s.value}" checked onchange="updateExportCount()">
                    ${s.label}
                </label>
            `).join('');

            // Reset date filters
            document.getElementById('export-date-from').value = '';
            document.getElementById('export-date-to').value = '';

            // Reset verified filter
            document.querySelector('input[name="export-verified"][value="all"]').checked = true;

            // Update count
            updateExportCount();

            // Show modal
            document.getElementById('export-modal').classList.add('active');
        }

        function exportTherapistsCSV() { openExportModal('therapists'); }
        function exportPatientsCSV() { openExportModal('patients'); }

        // Get filtered data based on export modal filters
        function getFilteredExportData() {
            const isTherapists = currentExportType === 'therapists';
            let data = isTherapists ? [...therapists] : [...patients];

            // Status filter
            const selectedStatuses = Array.from(document.querySelectorAll('#export-status-filters input:checked')).map(cb => cb.value);
            if (selectedStatuses.length > 0) {
                data = data.filter(item => selectedStatuses.includes(item.status));
            }

            // Date range filter
            const dateFrom = document.getElementById('export-date-from').value;
            const dateTo = document.getElementById('export-date-to').value;

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                data = data.filter(item => new Date(item.created_at) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59); // Include the entire day
                data = data.filter(item => new Date(item.created_at) <= toDate);
            }

            // Verified filter
            const verifiedFilter = document.querySelector('input[name="export-verified"]:checked').value;
            if (verifiedFilter === 'yes') {
                data = data.filter(item => isTherapists ? item.documents_verified : item.id_verified);
            } else if (verifiedFilter === 'no') {
                data = data.filter(item => isTherapists ? !item.documents_verified : !item.id_verified);
            }

            return data;
        }

        function updateExportCount() {
            const data = getFilteredExportData();
            document.getElementById('export-count').textContent = data.length;
        }

        // Add event listeners for date inputs
        document.getElementById('export-date-from')?.addEventListener('change', updateExportCount);
        document.getElementById('export-date-to')?.addEventListener('change', updateExportCount);
        document.querySelectorAll('input[name="export-verified"]').forEach(r => r.addEventListener('change', updateExportCount));

        function executeExport() {
            const data = getFilteredExportData();

            if (data.length === 0) {
                showToast('אין נתונים לייצוא עם הפילטרים הנבחרים', 'error');
                return;
            }

            if (currentExportType === 'therapists') {
                exportTherapistsData(data);
            } else {
                exportPatientsData(data);
            }

            closeModal('export-modal');
        }

        function exportTherapistsData(filteredData) {
            const headers = [
                'שם מלא', 'טלפון', 'אימייל', 'עיר', 'מגדר', 'התמחות',
                'שיטות טיפול', 'שנות ניסיון', 'מספר רישיון', 'השכלה',
                'עבודה בזום', 'עבודה פרונטלית', 'שעות פנויות בשבוע', 'קישור חיצוני',
                'מטופלים לאורך הקריירה', 'מטופלים פעילים',
                'שעות בחודש', 'תקופת התחייבות', 'אופן טיפול מועדף',
                'בעיות רפואיות', 'פירוט בעיות רפואיות', 'תרופות פסיכיאטריות', 'בטיפול אישי',
                'למה בחרת במקצוע', 'למה הצטרפת לפרויקט', 'ניסיון מעשי', 'מקרה מורכב', 'אתגרים',
                'מסמכים מאומתים', 'סטטוס', 'תאריך הרשמה'
            ];

            const rows = filteredData.map(t => {
                const q = t.questionnaire || {};
                const health = q.health || {};
                const commitment = q.commitment || {};
                const practice = q.practice || {};
                const methods = practice.treatment_methods || [];
                const methodsStr = Array.isArray(methods) ? methods.join(', ') : '';

                return [
                    t.full_name || '', t.phone || '', t.email || '', t.city || '',
                    genderDisplayLabel(t.gender), t.specialization || '', methodsStr,
                    t.experience_years || 0, t.license_number || '', t.education || '',
                    t.works_online ? 'כן' : 'לא', t.works_in_person ? 'כן' : 'לא',
                    t.available_hours_per_week || '', t.social_link || '',
                    practice.total_patients_estimate || 0, practice.current_active_patients || 0,
                    commitment.monthly_hours || '', commitment.duration_months || '', commitment.therapy_mode || '',
                    health.has_medical_issues ? 'כן' : 'לא', health.medical_issues_details || '',
                    health.takes_psychiatric_meds ? 'כן' : 'לא', health.in_personal_therapy ? 'כן' : 'לא',
                    q.why_profession || '', q.why_join || '', q.experience || '', q.case_study || '', q.challenges || '',
                    t.documents_verified ? 'כן' : 'לא', statusLabel(t.status), formatDate(t.created_at)
                ].map(escapeCSV);
            });

            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadCSV(csvContent, `therapists_${getDateString()}_filtered.csv`);
        }

        function exportPatientsData(filteredData) {
            const headers = [
                'שם מלא', 'טלפון', 'אימייל', 'עיר', 'העדפת טיפול', 'העדפת מגדר מטפל',
                'איש קשר לחירום', 'סיבת פנייה', 'טיפול קודם', 'ציפיות',
                'רקע משפחתי', 'רקע רפואי', 'תרופות', 'מידע נוסף',
                'זהות מאומתת', 'סטטוס', 'תאריך הרשמה'
            ];

            const rows = filteredData.map(p => {
                const q = p.questionnaire || {};
                return [
                    p.full_name || '', p.phone || '', p.email || '', p.city || '',
                    therapyTypeLabel(p.therapy_type), genderLabel(p.therapist_gender_preference),
                    q.emergency_contact || '', q.main_reason || '', q.previous_therapy || '', q.expectations || '',
                    q.family_background || '', q.medical_history || '', q.medications || '', q.additional_info || '',
                    p.id_verified ? 'כן' : 'לא', statusLabel(p.status), formatDate(p.created_at)
                ].map(escapeCSV);
            });

            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadCSV(csvContent, `patients_${getDateString()}_filtered.csv`);
        }

        // ===================
        // PRINT SIGNED DOCUMENT
        // ===================
        function printSignedDocument(type) {
            const isTherapist = type === 'therapist';
            const data = isTherapist ? currentViewedTherapist : currentViewedPatient;

            if (!data) {
                showToast('לא נמצאו נתונים להדפסה', 'error');
                return;
            }

            const today = new Date().toLocaleDateString('he-IL');
            const signedDate = data.created_at ? formatDateTime(data.created_at) : today;

            // Build details based on type
            let detailsHTML = '';
            let typeTitle = '';
            let additionalInfo = '';

            if (isTherapist) {
                typeTitle = 'תיק מטפל/ת';
                const q = data.questionnaire || {};
                const commitment = q.commitment || {};

                detailsHTML = `
                    <tr><td class="label">שם מלא:</td><td class="value">${data.full_name || '-'}</td></tr>
                    <tr><td class="label">טלפון:</td><td class="value">${data.phone || '-'}</td></tr>
                    <tr><td class="label">אימייל:</td><td class="value">${data.email || '-'}</td></tr>
                    <tr><td class="label">עיר מגורים:</td><td class="value">${data.city || '-'}</td></tr>
                    <tr><td class="label">תחום התמחות:</td><td class="value">${data.specialization || '-'}</td></tr>
                    <tr><td class="label">שנות ניסיון:</td><td class="value">${data.experience_years || 0}</td></tr>
                    <tr><td class="label">מספר רישיון:</td><td class="value">${data.license_number || '-'}</td></tr>
                    <tr><td class="label">אופן טיפול:</td><td class="value">${data.works_online ? 'זום' : ''} ${data.works_in_person ? 'פרונטלי' : ''}</td></tr>
                    <tr><td class="label">שעות התחייבות בחודש:</td><td class="value">${commitment.monthly_hours || '-'}</td></tr>
                    <tr><td class="label">תקופת התחייבות:</td><td class="value">${commitment.duration_months || '-'}</td></tr>
                `;

                additionalInfo = `
                    <div class="section">
                        <h3>הצהרות המטפל/ת</h3>
                        <ul>
                            <li>המטפל/ת מצהיר/ה כי יש ברשותו/ה ביטוח אחריות מקצועית בתוקף</li>
                            <li>המטפל/ת מבין/ה שכל האחריות המקצועית, החוקית והתיעודית היא עליו/ה בלבד</li>
                            <li>המטפל/ת משחרר/ת את הפלטפורמה מכל אחריות לטיפול או לתוצאותיו</li>
                        </ul>
                    </div>
                `;
            } else {
                typeTitle = 'תיק מטופל/ת';
                const q = data.questionnaire || {};

                detailsHTML = `
                    <tr><td class="label">שם מלא:</td><td class="value">${data.full_name || '-'}</td></tr>
                    <tr><td class="label">טלפון:</td><td class="value">${data.phone || '-'}</td></tr>
                    <tr><td class="label">אימייל:</td><td class="value">${data.email || '-'}</td></tr>
                    <tr><td class="label">עיר מגורים:</td><td class="value">${data.city || '-'}</td></tr>
                    <tr><td class="label">העדפת טיפול:</td><td class="value">${therapyTypeLabel(data.therapy_type)}</td></tr>
                    <tr><td class="label">העדפת מטפל/ת:</td><td class="value">${genderLabel(data.therapist_gender_preference)}</td></tr>
                    <tr><td class="label">איש קשר לחירום:</td><td class="value">${q.emergency_contact || '-'}</td></tr>
                `;

                if (q.main_reason) {
                    additionalInfo = `
                        <div class="section">
                            <h3>סיבת הפנייה</h3>
                            <p>${q.main_reason}</p>
                        </div>
                    `;
                }
            }

            // Create the print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>${typeTitle} - ${data.full_name}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&family=Heebo:wght@400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'David Libre', 'Heebo', serif;
            background: white;
            color: #1a1a1a;
            padding: 40px;
            line-height: 1.8;
            font-size: 14px;
        }

        .document {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #003B46;
            padding: 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px double #003B46;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #D4AF37, #c9a227);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #003B46;
            font-size: 28px;
        }

        .logo-text h1 {
            font-size: 22px;
            color: #003B46;
            font-weight: 700;
        }

        .logo-text p {
            font-size: 12px;
            color: #666;
        }

        .date-section {
            text-align: left;
            font-size: 13px;
            color: #666;
        }

        .title {
            text-align: center;
            margin-bottom: 30px;
        }

        .title h2 {
            font-size: 24px;
            color: #003B46;
            margin-bottom: 5px;
        }

        .title .subtitle {
            font-size: 14px;
            color: #D4AF37;
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            background: #003B46;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .details-table tr {
            border-bottom: 1px solid #e0e0e0;
        }

        .details-table td {
            padding: 12px 10px;
        }

        .details-table .label {
            font-weight: 700;
            color: #003B46;
            width: 180px;
        }

        .details-table .value {
            color: #333;
        }

        .section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #D4AF37;
        }

        .section h3 {
            font-size: 16px;
            color: #003B46;
            margin-bottom: 10px;
        }

        .section p, .section ul {
            color: #333;
            font-size: 13px;
        }

        .section ul {
            padding-right: 20px;
        }

        .section li {
            margin-bottom: 5px;
        }

        .legal-notice {
            background: linear-gradient(135deg, #003B46, #00606B);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .legal-notice h3 {
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legal-notice p {
            font-size: 13px;
            opacity: 0.95;
        }

        .signature-section {
            margin-top: 30px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .signature-section h3 {
            font-size: 16px;
            color: #003B46;
            margin-bottom: 15px;
        }

        .signature-box {
            background: white;
            border: 2px solid #003B46;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .signature-box img {
            max-width: 300px;
            max-height: 120px;
        }

        .signature-date {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 11px;
            color: #999;
        }

        .no-signature {
            color: #999;
            font-style: italic;
            padding: 30px;
        }

        @media print {
            body { padding: 0; }
            .document { border: none; padding: 20px; }
            @page { margin: 1cm; }
        }
    </style>
</head>
<body>
    <div class="document">
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon">❤</div>
                <div class="logo-text">
                    <h1>מטפל לכל אחד</h1>
                    <p>ריפוי הנפש לכל אדם</p>
                </div>
            </div>
            <div class="date-section">
                <div>תאריך הפקת המסמך:</div>
                <div><strong>${today}</strong></div>
            </div>
        </div>

        <div class="title">
            <h2>${typeTitle}</h2>
            <div class="subtitle">מסמך רשמי</div>
            <span class="badge">${isTherapist ? (data.documents_verified ? '✓ מסמכים מאומתים' : 'ממתין לאימות') : (data.id_verified ? '✓ זהות מאומתת' : 'ממתין לאימות')}</span>
        </div>

        <table class="details-table">
            ${detailsHTML}
            <tr><td class="label">תאריך הרשמה:</td><td class="value">${formatDate(data.created_at)}</td></tr>
            <tr><td class="label">סטטוס:</td><td class="value">${statusLabel(data.status)}</td></tr>
        </table>

        ${additionalInfo}

        <div class="legal-notice">
            <h3>📋 הצהרה משפטית</h3>
            <p>
                ${isTherapist ? 'המטפל/ת' : 'המטופל/ת'} חתם/ה באופן דיגיטלי על תנאי השימוש והמסמך המשפטי של פלטפורמת "מטפל לכל אחד".
                החתימה בוצעה בתאריך ${signedDate} ומהווה הסכמה מלאה לכל התנאים המפורטים במסמך.
            </p>
        </div>

        <div class="signature-section">
            <h3>חתימה דיגיטלית</h3>
            <div class="signature-box">
                ${data.signature_data
                    ? `<img src="${data.signature_data}" alt="חתימה דיגיטלית">`
                    : '<div class="no-signature">לא נמצאה חתימה דיגיטלית</div>'
                }
                <div class="signature-date">נחתם בתאריך: ${signedDate}</div>
            </div>
        </div>

        <div class="footer">
            <p>מסמך זה הופק אוטומטית ממערכת ה-CRM של "מטפל לכל אחד"</p>
            <p>www.therapistforeveryone.com</p>
        </div>
    </div>

    <` + `script>
        window.onload = function() {
            setTimeout(function() {
                window.print();
            }, 500);
        };
    <` + `/script>
</body>
</html>
            `);
            printWindow.document.close();
        }
    </script>
    <!-- Marketing & Analytics -->
    <script src="../js/marketing-tools.js"></script>
</body>
</html>
