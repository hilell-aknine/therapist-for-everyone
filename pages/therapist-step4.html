<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שלב 4 - הסכם וחתימה | מטפל לכל אחד</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2F8592;
            --primary-dark: #003B46;
            --gold: #D4AF37;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a2e;
            --text-light: #6c757d;
            --border: #e0e0e0;
            --success: #28a745;
            --error: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Heebo', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .header p { opacity: 0.9; font-size: 0.95rem; }

        .progress-container {
            background: white;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            max-width: 500px;
            margin: 0 auto;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }
        .step.completed:not(:last-child)::after {
            background: var(--gold);
        }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        .step.active .step-circle {
            background: var(--gold);
            color: var(--primary-dark);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2);
        }
        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }
        .step-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
        }
        .step.active .step-label {
            color: var(--primary-dark);
            font-weight: 500;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
            padding: 1.5rem 1rem 2rem;
        }
        .form-card {
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .section-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--gold), #e8c252);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--primary-dark);
            font-size: 1.5rem;
        }
        .section-header h2 {
            color: var(--primary-dark);
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }
        .section-header p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Terms Box - Scroll Lock */
        .terms-box {
            max-height: 300px;
            overflow-y: auto;
            padding: 1.5rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fafafa;
            font-size: 0.9rem;
            line-height: 1.8;
            margin-bottom: 1rem;
        }
        .terms-box h4 {
            color: var(--primary-dark);
            margin: 1.5rem 0 0.8rem 0;
            font-size: 1rem;
        }
        .terms-box h4:first-child {
            margin-top: 0;
        }
        .terms-box p {
            margin-bottom: 0.8rem;
        }
        .terms-box strong {
            color: var(--primary-dark);
        }

        .scroll-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
            border: 1px solid rgba(220, 53, 69, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--error);
            margin-bottom: 1.5rem;
            animation: pulse 2s infinite;
        }
        .scroll-hint.hidden {
            display: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Checkboxes */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin-bottom: 0.8rem;
            transition: all 0.3s;
        }
        .checkbox-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: 400;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .checkbox-group .required { color: var(--error); }

        /* Signature Canvas */
        .signature-section {
            margin-top: 1.5rem;
        }
        .signature-section > label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .signature-canvas-container {
            border: 2px dashed var(--border);
            border-radius: 12px;
            position: relative;
            background: white;
            overflow: hidden;
        }
        #signature-canvas {
            width: 100%;
            height: 150px;
            display: block;
            cursor: crosshair;
        }
        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-light);
            pointer-events: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .signature-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        .btn-clear {
            background: none;
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .btn-clear:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--gold), #c9a227);
            color: var(--primary-dark);
            flex: 2;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: white;
            color: var(--text);
            border: 1.5px solid var(--border);
            flex: 1;
        }
        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Success Message */
        .success-container {
            text-align: center;
            padding: 2rem;
        }
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success), #20c997);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2.5rem;
        }
        .success-container h2 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }
        .success-container p {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #25D366;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 1.5rem;
            transition: all 0.2s;
        }
        .whatsapp-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
        }
        .home-link {
            display: block;
            margin-top: 1rem;
            color: var(--primary);
            text-decoration: none;
        }

        .hidden { display: none; }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--error); color: white; }

        @media (max-width: 600px) {
            .container { padding: 1rem; }
            .form-card { padding: 1.5rem; }
            .step-label { font-size: 0.65rem; }
            .nav-buttons { flex-direction: column-reverse; }
            .btn-secondary, .btn-primary { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fa-solid fa-user-doctor"></i> מטפל לכל אחד</h1>
        <p>הצטרפות למאגר המטפלים</p>
    </div>

    <div class="progress-container">
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-circle"><i class="fa-solid fa-check" style="font-size: 0.7rem;"></i></div>
                <div class="step-label">פרופיל מקצועי</div>
            </div>
            <div class="step completed">
                <div class="step-circle"><i class="fa-solid fa-check" style="font-size: 0.7rem;"></i></div>
                <div class="step-label">עומק ומניע</div>
            </div>
            <div class="step completed">
                <div class="step-circle"><i class="fa-solid fa-check" style="font-size: 0.7rem;"></i></div>
                <div class="step-label">בריאות והתחייבות</div>
            </div>
            <div class="step active">
                <div class="step-circle">4</div>
                <div class="step-label">הסכם וחתימה</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Form -->
        <div class="form-card" id="form-container">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fa-solid fa-file-signature"></i>
                </div>
                <h2>הסכם הצטרפות</h2>
                <p>נא לקרוא את ההסכם בעיון לפני חתימה</p>
            </div>

            <div class="terms-box" id="terms-box">
                <h4>הסכם הצטרפות, קוד אתי וכתב שיפוי – למטפל/ת</h4>

                <h4>1. מעמד המטפל: מתנדב עצמאי (Independent Volunteer)</h4>
                <p><strong>1.1 העדר יחסי עובד-מעביד:</strong> אני מצהיר/ה כי פעילותי באתר הינה התנדבותית כספק שירות עצמאי. לא מתקיימים ביני לבין הנהלת האתר יחסי עובד-מעביד, שליחות או שותפות. אינני זכאי/ת לתשלום, תנאים סוציאליים או פיצויים מהאתר.</p>
                <p><strong>1.2 תואר מותר לשימוש:</strong> בכל פרסום חיצוני (לינקדאין, אתר אישי), הנני רשאי/ת להציג את עצמי כ"מתנדב/ת במיזם" בלבד, ולא כ"מטפל מורשה מטעם המיזם" או כנציג רשמי שלו.</p>

                <h4>2. אחריות מקצועית, חוקית ופיזית</h4>
                <p><strong>2.1 אחריות מקצועית מלאה:</strong> הפלטפורמה משמשת כלוח מודעות טכנולוגי בלבד. כל האחריות המקצועית, האתית והטיפולית חלה עלי בלבד.</p>
                <p><strong>2.2 חובת הדיווח (Mandatory Reporting):</strong> ידוע לי כי חובות דיווח על פי חוק (כגון חובת דיווח על קטין בסיכון, חסר ישע או אלימות במשפחה) חלות עלי אישית כמטפל. הדיווח להנהלת האתר אינו מהווה תחליף לדיווח לרשויות.</p>
                <p><strong>2.3 אחריות למקום הטיפול:</strong> במידה והטיפול מתקיים בקליניקה פיזית, האחריות לביטוח המקום (צד ג') ובטיחות המטופל מוטלת עלי בלבד. האתר אינו אחראי לכל נזק גוף או רכוש.</p>
                <p><strong>2.4 הדרכה מקצועית:</strong> ידוע לי כי האתר אינו מספק הדרכה מקצועית. באחריותי לדאוג להדרכה (סופרוויז'ן) חיצונית.</p>

                <h4>3. שמירת רשומות ומחיקת מידע</h4>
                <p><strong>3.1 מדיניות מחיקה:</strong> ידוע לי כי נתוני המטופלים וההתקשרות נמחקים משרתי האתר באופן אוטומטי 90 יום לאחר סיום הטיפול.</p>
                <p><strong>3.2 חובת תיעוד עצמאית:</strong> באחריותי הבלעדית לנהל, לשמור ולאבטח את הרשומה הטיפולית במערכות שלי. לא תהיה לי כל טענה כלפי האתר בגין אובדן מידע שנמחק מהשרתים.</p>

                <h4>4. חופש פעולה מסחרי וטיפולי</h4>
                <p><strong>4.1 המשך התקשרות:</strong> הפלטפורמה אינה צד להתנהלות הכספית. זכותי להציע שירותים בתשלום (במהלך או בתום 10 המפגשים), וזאת באחריותי הבלעדית.</p>
                <p><strong>4.2 סיום התקשרות:</strong> זכותי לסיים את ההתנדבות בכל עת. מצופה ממני לנהוג במקצועיות ולבצע סיום תהליך מכבד.</p>

                <h4>5. מדיניות השעיה ובירור</h4>
                <p>ידוע לי כי להנהלת האתר שמורה הזכות להפסיק את גישתי למערכת בכל עת וללא נימוק, וזאת במידה ויעלה חשש כי פעילותי פוגעת בשמו הטוב של המיזם או בבטיחות המשתמשים.</p>

                <h4>6. ביטוח ושיפוי</h4>
                <p><strong>6.1 ביטוח:</strong> אני מתחייב/ת להחזיק בביטוח אחריות מקצועית בתוקף המכסה את כל פעילותי.</p>
                <p><strong>6.2 שיפוי (Indemnification):</strong> אני משחרר/ת את הפלטפורמה מכל אחריות לנזק שייגרם למטופל, ומתחייב/ת לשפות את מפעילת האתר בגין כל תביעה שתופנה כלפיה עקב מעשה או מחדל שלי.</p>
            </div>

            <div class="scroll-hint" id="scroll-hint">
                <i class="fa-solid fa-arrow-down"></i>
                גלול/י למטה כדי לקרוא את כל ההסכם ולאפשר חתימה
            </div>

            <form id="step4-form">
                <div class="checkbox-group disabled" id="insurance-group">
                    <input type="checkbox" id="has_insurance" name="has_insurance" disabled required>
                    <label for="has_insurance">
                        אני מאשר/ת שיש ברשותי ביטוח אחריות מקצועית בתוקף <span class="required">*</span>
                    </label>
                </div>

                <div class="checkbox-group disabled" id="responsibility-group">
                    <input type="checkbox" id="accepts_responsibility" name="accepts_responsibility" disabled required>
                    <label for="accepts_responsibility">
                        אני מבין/ה שכל האחריות המקצועית, החוקית (דיווח) והתיעודית היא עלי בלבד <span class="required">*</span>
                    </label>
                </div>

                <div class="checkbox-group disabled" id="waiver-group">
                    <input type="checkbox" id="waiver_confirmed" name="waiver_confirmed" disabled required>
                    <label for="waiver_confirmed">
                        אני משחרר/ת את האתר מכל אחריות לטיפול או לתוצאותיו <span class="required">*</span>
                    </label>
                </div>

                <div class="signature-section">
                    <label>חתימה דיגיטלית <span class="required">*</span></label>
                    <div class="signature-canvas-container">
                        <canvas id="signature-canvas"></canvas>
                        <div class="signature-placeholder" id="signature-placeholder">
                            <i class="fa-solid fa-pen"></i> חתום/י כאן
                        </div>
                    </div>
                    <div class="signature-actions">
                        <button type="button" class="btn-clear" onclick="clearSignature()">
                            <i class="fa-solid fa-eraser"></i> נקה חתימה
                        </button>
                    </div>
                </div>

                <div class="nav-buttons">
                    <a href="therapist-step3.html" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-right"></i> חזרה
                    </a>
                    <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                        <i class="fa-solid fa-paper-plane"></i> שליחת הבקשה
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        <div class="form-card hidden" id="success-container">
            <div class="success-container">
                <div class="success-icon">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2>הבקשה נשלחה בהצלחה!</h2>
                <p>פרטיך התקבלו. אנו נבחן את הבקשה ונחזור אליך בהקדם לאישור הצטרפות לקהילה.</p>
                <p>כעת יש לשלוח את המסמכים לאימות:</p>
                <a href="https://wa.me/972501234567?text=שלום, שלחתי בקשה להצטרף כמטפל. מצרף מסמכים לאימות." class="whatsapp-link" target="_blank">
                    <i class="fa-brands fa-whatsapp"></i>
                    שלח מסמכים בוואטסאפ
                </a>
                <a href="../index.html" class="home-link">
                    <i class="fa-solid fa-home"></i> חזרה לדף הבית
                </a>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://eimcudmlfjlyxjyrdcgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbWN1ZG1sZmpseXhqeXJkY2djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MTA5MDYsImV4cCI6MjA4NDk4NjkwNn0.ESXViZ0DZxopHxHNuC6vRn3iIZz1KZkQcXwgLhK_nQw';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const termsBox = document.getElementById('terms-box');
        const scrollHint = document.getElementById('scroll-hint');
        const submitBtn = document.getElementById('submit-btn');
        let hasScrolledToBottom = false;
        let hasSignature = false;

        // Check if previous steps were completed
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('therapist_form_data');
            if (!saved) {
                window.location.href = 'therapist-step1.html';
                return;
            }

            const data = JSON.parse(saved);
            if (!data.monthly_hours) {
                window.location.href = 'therapist-step3.html';
                return;
            }

            // Initialize canvas
            resizeCanvas();
        });

        // ===================
        // SCROLL-LOCK MECHANISM
        // ===================
        termsBox.addEventListener('scroll', () => {
            const scrolledToBottom = termsBox.scrollHeight - termsBox.scrollTop <= termsBox.clientHeight + 15;
            if (scrolledToBottom && !hasScrolledToBottom) {
                hasScrolledToBottom = true;
                enableCheckboxes();
                scrollHint.classList.add('hidden');
            }
        });

        function enableCheckboxes() {
            ['insurance-group', 'responsibility-group', 'waiver-group'].forEach(id => {
                const group = document.getElementById(id);
                const checkbox = group.querySelector('input[type="checkbox"]');
                group.classList.remove('disabled');
                checkbox.disabled = false;
            });
        }

        // ===================
        // SIGNATURE CANVAS
        // ===================
        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('signature-placeholder');
        let isDrawing = false;

        function resizeCanvas() {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 150;
        }
        window.addEventListener('resize', resizeCanvas);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            placeholder.style.display = 'none';
            e.preventDefault();
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
            hasSignature = true;
            e.preventDefault();
        }

        function stopDrawing() {
            isDrawing = false;
            validateForm();
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasSignature = false;
            placeholder.style.display = 'flex';
            validateForm();
        }

        // ===================
        // VALIDATION
        // ===================
        function validateForm() {
            const insuranceChecked = document.getElementById('has_insurance').checked;
            const responsibilityChecked = document.getElementById('accepts_responsibility').checked;
            const waiverChecked = document.getElementById('waiver_confirmed').checked;

            const allChecked = insuranceChecked && responsibilityChecked && waiverChecked;
            const canSubmit = hasScrolledToBottom && allChecked && hasSignature;

            submitBtn.disabled = !canSubmit;
        }

        ['has_insurance', 'accepts_responsibility', 'waiver_confirmed'].forEach(id => {
            document.getElementById(id).addEventListener('change', validateForm);
        });

        // ===================
        // FORM SUBMISSION
        // ===================
        document.getElementById('step4-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!hasSignature) {
                showToast('נא לחתום על ההסכם', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> שולח...';

            try {
                const formData = JSON.parse(localStorage.getItem('therapist_form_data') || '{}');
                const signatureData = canvas.toDataURL('image/png');

                // Build questionnaire JSONB
                const questionnaire = {
                    // Deep questions
                    why_profession: formData.q_why_profession || '',
                    why_join: formData.q_why_join || '',
                    experience: formData.q_experience || '',
                    case_study: formData.q_case_study || '',
                    challenges: formData.q_challenges || '',

                    // Health declarations
                    health: {
                        has_medical_issues: formData.has_medical_issues === 'yes',
                        medical_issues_details: formData.medical_issues_details || '',
                        takes_psychiatric_meds: formData.takes_psychiatric_meds === 'yes',
                        in_personal_therapy: formData.in_personal_therapy === 'yes'
                    },

                    // Commitment
                    commitment: {
                        monthly_hours: parseInt(formData.monthly_hours) || 10,
                        duration_months: formData.commitment_duration,
                        therapy_mode: formData.therapy_mode
                    },

                    // Practice info
                    practice: {
                        total_patients_estimate: parseInt(formData.total_patients_estimate) || 0,
                        current_active_patients: parseInt(formData.current_active_patients) || 0,
                        treatment_methods: formData.treatment_methods || []
                    },

                    // Legal confirmations
                    legal: {
                        has_insurance: document.getElementById('has_insurance').checked,
                        accepts_responsibility: document.getElementById('accepts_responsibility').checked,
                        waiver_confirmed: document.getElementById('waiver_confirmed').checked,
                        scrolled_terms: hasScrolledToBottom,
                        signed_at: new Date().toISOString()
                    }
                };

                // Calculate experience years
                const practiceStartYear = parseInt(formData.practice_start_year);
                const currentYear = new Date().getFullYear();
                const experienceYears = practiceStartYear ? currentYear - practiceStartYear : 0;

                const data = {
                    full_name: formData.full_name,
                    email: formData.email || null,
                    phone: formData.phone,
                    city: formData.city || null,
                    birth_date: formData.birth_date || null,
                    gender: formData.gender || null,
                    specialization: formData.specialization,
                    experience_years: experienceYears,
                    license_number: formData.license_number || null,
                    education: formData.education || null,
                    works_online: formData.therapy_mode === 'zoom' || formData.therapy_mode === 'hybrid',
                    works_in_person: formData.therapy_mode === 'clinic' || formData.therapy_mode === 'hybrid',
                    available_hours_per_week: Math.ceil(parseInt(formData.monthly_hours || 10) / 4),
                    social_link: formData.social_link || null,
                    questionnaire: questionnaire,
                    signature_data: signatureData,
                    age_confirmed: true,
                    terms_confirmed: true,
                    documents_verified: false,
                    status: 'new'
                };

                const { error } = await db.from('therapists').insert(data);
                if (error) throw error;

                // Clear localStorage
                localStorage.removeItem('therapist_form_data');

                // Show success
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-container').classList.remove('hidden');
                showToast('הבקשה נשלחה בהצלחה!', 'success');

            } catch (error) {
                console.error('Error:', error);
                showToast('שגיאה בשליחת הטופס. נסה שוב.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> שליחת הבקשה';
            }
        });

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>
